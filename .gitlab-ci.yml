image: python:3.11

stages:
  - install
  - test
  - deploy

variables:
  PLAYWRIGHT_BROWSERS_PATH: /ms-playwright
  ALLURE_RESULTS: allure-results
  PAGES_DIR: public

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .cache/pip
    - $PLAYWRIGHT_BROWSERS_PATH

# 1. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°
install:
  stage: install
  script:
    - pip install --upgrade pip
    - pip install pytest pytest-playwright requests allure-pytest
    - playwright install --with-deps chromium
  cache:
    paths:
      - .cache/pip
      - $PLAYWRIGHT_BROWSERS_PATH

# 2. Ð—Ð°Ð¿ÑƒÑÐº Ñ‚ÐµÑÑ‚Ð¾Ð² Ñ Allure
test:
  stage: test
  script:
    - |
      echo "Running tests with Allure annotations..."
      python -m pytest tests/ \
        -v \
        --alluredir=$ALLURE_RESULTS \
        --clean-alluredir
  artifacts:
    when: always
    paths:
      - $ALLURE_RESULTS
    expire_in: 1 week

# 3. Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ ÐºÑ€Ð°ÑÐ¸Ð²Ð¾Ð³Ð¾ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°
generate-allure:
  stage: deploy
  image: frankescobar/allure-docker-service:latest
  needs: ["test"]
  script:
    - |
      echo "ðŸ“Š Generating Allure report..."
      allure generate $ALLURE_RESULTS \
        -o $PAGES_DIR \
        --clean
      
      # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÐºÐ°ÑÑ‚Ð¾Ð¼Ð¸Ð·Ð°Ñ†Ð¸ÑŽ
      echo "ðŸŽ¨ Customizing report..."
      cat > $PAGES_DIR/plugins/behaviors/behaviors.json << 'EOF'
      {
        "testResult": {
          "labels": {
            "severity": "Severity",
            "feature": "Feature",
            "story": "Story"
          }
        }
      }
      EOF
  artifacts:
    paths:
      - $PAGES_DIR
    expire_in: 1 week

# 4. ÐŸÑƒÐ±Ð»Ð¸ÐºÐ°Ñ†Ð¸Ñ Ð½Ð° GitLab Pages
pages:
  stage: deploy
  dependencies:
    - generate-allure
  script:
    - echo "ðŸš€ Deploying to GitLab Pages..."
    - echo "Report will be available at: https://$CI_PROJECT_NAMESPACE.gitlab.io/$CI_PROJECT_NAME/"
  artifacts:
    paths:
      - $PAGES_DIR
  only:
    - main
    - master